<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>C64 Remote Programmer</title>
    <meta name="description" content="In this post I will describe a small electronics project designed to enable the remote programming of a real Commodore 64 that is switched on and running. To achieve this, several parts are involed, utilising some custom circuitry and communications proto...">
    <meta name="author"      content="pezi">
    <meta name="keywords"    content="C64, C, fsharp, raspberry pi, electronics, asi64, 6502">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="http://www.pinksquirrellabs.com/blog\2018\11\21\c64-remote-programmer/">
    <link rel="next" href="/blog\2018\10\05\c64-macro-state-machine/">
    <link rel="prev" href="/blog\2019\04\17\fairylog/">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds\all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds\all.rss.xml" title="RSS Feed">
    <!-- JS -->

  </head>
  <body>
    <!-- A standard Twitter Bootstrap nav bar -->
    <header class="navbar navbar-default navbar-inverse"
            role="banner">
      <div class="container">
        <div class="navbar-header">
          <button type="button"
                  class="navbar-toggle"
                  data-toggle="collapse"
                  data-target=".our-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="/index.html" class="navbar-brand">Pink Squirrel Labs</a>
        </div>
        <div class="collapse navbar-collapse our-nav-collapse"
             role="navigation">
          <ul class="nav navbar-nav">

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="/index.html">All Posts</a></li>

<li><a href="/tags\6502.html">6502</a></li>

<li><a href="/tags\asi64.html">asi64</a></li>

<li><a href="/tags\books.html">books</a></li>

<li><a href="/tags\C.html">C</a></li>

<li><a href="/tags\C64.html">C64</a></li>

<li><a href="/tags\compilers.html">compilers</a></li>

<li><a href="/tags\cracking.html">cracking</a></li>

<li><a href="/tags\D.html">D</a></li>

<li><a href="/tags\digital-logic.html">digital logic</a></li>

<li><a href="/tags\drey.html">drey</a></li>

<li><a href="/tags\electronics.html">electronics</a></li>

<li><a href="/tags\fairylog.html">fairylog</a></li>

<li><a href="/tags\fpga.html">fpga</a></li>

<li><a href="/tags\fsharp.html">fsharp</a></li>

<li><a href="/tags\game-programming.html">game programming</a></li>

<li><a href="/tags\macros.html">macros</a></li>

<li><a href="/tags\programming-languages.html">programming languages</a></li>

<li><a href="/tags\racket.html">racket</a></li>

<li><a href="/tags\raspberry-pi.html">raspberry pi</a></li>

<li><a href="/tags\reverse-engineering.html">reverse engineering</a></li>

<li><a href="/tags\robotics.html">robotics</a></li>

<li><a href="/tags\roguelike.html">roguelike</a></li>

<li><a href="/tags\scurry.html">scurry</a></li>

<li><a href="/tags\sqlprovider.html">sqlprovider</a></li>

<li><a href="/tags\squirrels.html">squirrels</a></li>

<li><a href="/tags\type-providers.html">type providers</a></li>

<li><a href="/tags\xrm.html">xrm</a></li>
              </ul>
            </li>
            <li>
              <a href="/About.html">About</a>
            </li> 
            <li><a href="/feeds\all.atom.xml">Atom</a></li>
            <li><a href="/feeds\all.rss.xml">RSS</a></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row">

        <!-- Main column -->
        <div id="content" class="col-md-12">





          <article>
  <header>
    <ul class="pager">
    <li class="previous">
      <a href="/blog\2019\04\17\fairylog/">&larr; <em>Fairylog</em></a>
    </li>
    <li class="next">
      <a href="/blog\2018\10\05\c64-macro-state-machine/"><em>C64 Macro State Machine</em> &rarr;</a>
    </li>
    </ul>
    <h1>C64 Remote Programmer</h1>
    <p class='date-and-tags'>
<time datetime="2018-11-21" pubdate="true">2018-11-21</time> :: <span class="tags"><a href="/tags\C64.html">C64</a>, <a href="/tags\C.html">C</a>, <a href="/tags\fsharp.html">fsharp</a>, <a href="/tags\raspberry-pi.html">raspberry pi</a>, <a href="/tags\electronics.html">electronics</a>, <a href="/tags\asi64.html">asi64</a>, <a href="/tags\6502.html">6502</a></span></p>
  </header>

<p>In this post I will describe a small electronics project designed to enable the remote programming of a real Commodore 64 that is switched on and running. To achieve this, several parts are involed, utilising some custom circuitry and communications protocol, a Raspberry Pi, a C program, a 6502 assembler program and a little F# program to finish it off.</p>

<div class="figure"><img src="../../../../../img/prog/programmer1.jpg" alt="" />
 <p class="caption"></p></div>
<!-- more-->

<h2 id="introduction">Introduction</h2>

<p>Programming the C64 is a lot of fun, and mostly you can get by with using an <a href="http://vice-emu.sourceforge.net/">emulator</a>. However, there comes a time when you wish to run your program on the real machine. To facilitate this, I own a very awesome <a href="http://www.1541ultimate.net/content/index.php">1541 Ultimate 2</a> which mimics the <a href="https://en.wikipedia.org/wiki/Commodore_1541">Commodore 1541</a> floppy drive and allows you to load things from a USB stick. Whilst this is really cool, it is still annoying having to keep moving the program from my main machine to the C64 with the stick to see small changes. The 1541 Ultimate 2 does have an ethernet port which I think you can use to send new code over (not sure how that works, or if it lets you change a running program&hellip;), but what I really want is a way whereby I have my program running on the C64, and then when I assemble a new version of the program on my main machine, it magically writes itself over the top of whatever is currently running, and starts executing on the C64 with no hard connection.</p>

<h2 id="high-level-design">High Level Design</h2>

<p>The general idea is to connect the <a href="https://www.c64-wiki.com/wiki/User_Port">C64&rsquo;s user port</a> to a <a href="https://www.raspberrypi.org/">Raspberry Pi</a>, and design a protocol to transfer data from one to the other. The C64 side will have to include a small assembly program to do this, whilst the Pi will be running a small C program.</p>

<p>The Pi is notified of a new program to send by monitoring a specific directory. The main machine, post-assembly, augments and sends the output file over <a href="https://en.wikipedia.org/wiki/Secure_copy">SCP</a> to the Pi using a small F# program.</p>

<div class="figure"><img src="../../../../../img/prog/high-level.png" alt="" />
 <p class="caption"></p></div>

<h2 id="protocol-design">Protocol Design</h2>

<p>The C64 has a user port which is designed for us to connect our own circuits to. You must be careful, of course! You can easily damage the machine if you are not careful, and I don&rsquo;t know if my user port even works. The usable part of the port is essentially 10 pins &ndash; 8 data pins that form a register you can read at <code>$dd01</code>, and two pins you can use for handshaking with another device. Of these two pins, one is special - the <code>FLAG</code> pin. This pin is input only, and detects negative edges. Upon seeing a logic transition from HIGH to LOW, it sets a bit in the port&rsquo;s interrupt control register at <code>$dd0d</code>. This bit is cleared when you read the register. If you wish, you can also have it raise a non-maskable interrupt (NMI) enabling you to program with it asynchronously.</p>

<div class="figure"><img src="../../../../../img/prog/userport.gif" alt="" />
 <p class="caption"></p></div>

<p>The C64&rsquo;s KERNAL has some routines that use this port to enable RS&ndash;232 communication. RS&ndash;232 is horribly slow however, being a serial protocol it transmits only a single bit at a time, with the protocol orchestration overhead on top of that. For my purposes, I want something much faster and less general. It doesn&rsquo;t need to be bullet-proof since it is only for my own use. I would like to use all 8 lines to transfer a whole byte at a time as a parrallel interface.</p>

<p>Of course, the Raspberry Pi is ridiculously faster than the C64, so the top speed will be largely down to how fast the 6502 can process the incoming data. To that end, the C64 side of the programmer aims to do the least amount of work as possible, with hardly any logic and only copying of data.</p>

<h3 id="low-level">Low Level</h3>

<p>The low-level handshaking and transmission details are as follows</p>

<ul>
 <li>The Pi signals to the C64 there is a new byte available by cycling the <code>FLAG</code> line from HIGH to LOW and back again, after writing the bits to the 8 lines.</li>
 <li>The C64 loads the data and puts it somewhere, and then inverts the other handshaking line <code>PA2</code></li>
 <li>The Pi notices the C64 has finished with the data by polling <code>PA2</code>, and then sends the next byte.</li></ul>

<h3 id="high-level">High Level</h3>

<p>The 6502 is very good at copying whole pages of data (256 bytes) since it can use its indexed addressing modes to whip through 256 bytes and easily check when it has finished. The data being sent, however, could be destined for any memory location and be of any length. Therefore, to simplify the job for the C64, we will send it some control bytes about any non-perfectly aligned data as a header, which will be the job of the C program on the Pi to compute.</p>

<ul>
 <li>1 : low byte of the location to start executing once programming has finished</li>
 <li>2 : high byte</li>
 <li>3 : low byte of the location to being copying data to</li>
 <li>4 : high byte</li>
 <li>5 : total amount of full pages of data to copy</li>
 <li>6 : number of leading bytes that don&rsquo;t fill a page</li>
 <li>7 : number of trailing bytes that don&rsquo;t fill a page</li></ul>

<p>The idea then is for the assembly program to:</p>

<ul>
 <li>disable interrupts</li>
 <li>create a pointer to the start location</li>
 <li>copy the amount of leading bytes</li>
 <li>repeatedly copy the full pages</li>
 <li>copy the trailing bytes</li>
 <li>enable interrupts, splat the stack</li>
 <li>jump to the execution point</li></ul>

<p>We will see how some of this is implemented later.</p>

<h2 id="circuit-design">Circuit Design</h2>

<p>The C64 is of course an old device released back in 1983 (when I was born!) and as such it uses +/&ndash; 5v for its logic lines. The Pi is newer and uses the more modern +3.3v for its logic. This means they cannot directly communicate - whilst you can get away with sending 3.3v to a 5v pin, you shouldn&rsquo;t really, and sending 5v to a 3.3v pin is a definite no!</p>

<p>To solve this problem you&rsquo;d typically use a <a href="https://www.adafruit.com/product/735">level shifter</a>, however, I couldn&rsquo;t find one in my stuff so instead I decided to solve the problem in another way, by using a transistor switching circuit.</p>

<p>One of the transistor&rsquo;s primary features is that is able to switch on a larger current / voltage using a very small one. We can use this feature to solve our problem. However, in its most basic configuration, this circuit is also a NOT gate - it inverts the input.</p>

<div class="figure"><img src="../../../../../img/prog/transistor-1.png" alt="" />
 <p class="caption"></p></div>

<p>We have 9 of these in total, one for each data pin and one for the <code>FLAG</code> pin. The transistor is switched on using the 3.3v logic, and it ouputs the opposite logic in 5v to the C64.</p>

<div class="figure"><img src="../../../../../img/prog/transistor-2.png" alt="" />
 <p class="caption"></p></div>

<p>And one of these for the <code>PA2</code> handshaking pin from the C64 to the Pi. It is the same, except it is switched on from the C64&rsquo;s 5v logic and outputs 3.3v.</p>

<p>I have kept these diagrams high level since this post is not about the electronics really. I did extensive testing on each part of the circuit and the logic outputs from both devices before putting it all together. The picture below is the Pi&rsquo;s logic pins driving the transistors and LEDs using a small C program, acting as a binary counter.</p>

<div class="figure"><img src="../../../../../img/prog/programmer2.jpg" alt="" />
 <p class="caption"></p></div>

<p>Of course, since the circuits invert the logic, the received bytes will be incorrect. We can remedy this by either designing a more complex circuit, or changing how the data is sent / received. It makes sense in this instance to modify how the data is sent since I don&rsquo;t want to make the circuit more complex and I don&rsquo;t want the 6502 program to do anything it doesn&rsquo;t have to.</p>

<h2 id="c-program">C Program</h2>

<p>The C program&rsquo;s job is to monitor a directory, and when it sees a new file, send it over the wire. It expects the first four bytes of the file will be the post-programming execution address and address to start writing the data as per the protocol section above (more on how these end up in the file in the final section)</p>

<p>Some of the C program is quite boring, so we&rsquo;ll look at a couple of the more interesting parts. The library being used here is <a href="https://www.airspayce.com/mikem/bcm2835/">bcm2835</a> to control the GPIO pins on the Pi.</p>

<div class="brush: C">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">send_byte</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// write inverted bits</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">PB0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">PB1</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">PB2</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">PB3</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">PB4</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">PB5</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">PB6</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">PB7</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// c64 detects negative edge and sets an interrupt bit</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// get the current c64 output flag first</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">pa2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bcm2835_gpio_lev</span><span class="p">(</span><span class="n">PA2</span><span class="p">);</span>

<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">FLAG2</span><span class="p">,</span><span class="w"> </span><span class="n">HIGH</span><span class="p">);</span><span class="w">  </span><span class="c1">// cycle the line low to trigger interrup</span>
<span class="w">  </span><span class="n">bcm2835_gpio_write</span><span class="p">(</span><span class="n">FLAG2</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span><span class="w">   </span><span class="c1">// reset again</span>

<span class="w">  </span><span class="c1">// now wait for the c64 to change its output flag</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="n">bcm2835_gpio_lev</span><span class="p">(</span><span class="n">PA2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pa2</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">  </span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Here we implement the low level details of the protocol, loading each bit of the byte onto the data lines, inverted so the circuit ends up outputting the correct value. Then it switches the <code>FLAG</code> line and waits for the C64 to respond by inverting <code>PA2</code>, indicating that it has taken the data (ack).</p>

<div class="brush: C">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="w">      </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">fp</span><span class="p">;</span>
<span class="w">      </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">"r"</span><span class="p">);</span>
<span class="w">      </span><span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_END</span><span class="p">);</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">file_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">data_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">      </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">data_length</span><span class="p">);</span>
<span class="w">      </span><span class="n">rewind</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">start_lo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">start_hi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">asm_lo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">asm_hi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="n">fread</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">data_length</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">);</span>
<span class="w">      </span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">asm_hi</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">asm_lo</span><span class="p">;</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">"data load complete. copy address at $%04X.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// work out how many bytes are on the first page</span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">first_page_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="p">);</span>

<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">remaining_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">first_page_bytes</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// see how many full pages we can fit in</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">full_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remaining_bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// and any final stragglers</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">last_page_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remaining_bytes</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>

<span class="w">      </span><span class="c1">//now we can send to the C64!</span>
<span class="w">      </span><span class="c1">//first send the control data.</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">"sending control headers..</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">      </span><span class="n">send_byte</span><span class="p">(</span><span class="n">start_lo</span><span class="p">);</span>
<span class="w">      </span><span class="n">send_byte</span><span class="p">(</span><span class="n">start_hi</span><span class="p">);</span>
<span class="w">      </span><span class="n">send_byte</span><span class="p">(</span><span class="n">asm_lo</span><span class="p">);</span>
<span class="w">      </span><span class="n">send_byte</span><span class="p">(</span><span class="n">asm_hi</span><span class="p">);</span>
<span class="w">      </span><span class="n">send_byte</span><span class="p">(</span><span class="n">full_pages</span><span class="p">);</span>
<span class="w">      </span><span class="n">send_byte</span><span class="p">(</span><span class="n">first_page_bytes</span><span class="p">);</span>
<span class="w">      </span><span class="n">send_byte</span><span class="p">(</span><span class="n">last_page_bytes</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data_length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">             </span><span class="n">send_byte</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">      </span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>In this code we extract the first 4 bytes from the file then read the rest into an array. Then we can work out any leading / trailing bytes as per the protocol description, and finally proceed to send the control header followed by the actual data. (this is not the actual code, but close enough - I changed it around to fit in the post)</p>

<h2 id="6502-program">6502 Program</h2>

<p>For the C64 side, we want the program to be as small as possible. Obviously, it needs to fit somewhere inside your program, where you can call it every now and then to see if a new program has arrived. The location it lives should ideally remain static as your program changes, since the programmer will overwrite itself and it had better be in exactly the same place whilst it is doing it!</p>

<p>For now, the perfect spot for this is the area that follows the BASIC program that is executed when the machine first boots. A common machine language trick is to put your own short basic program there, its purpose is to transfer control to your actual program so you don&rsquo;t have to type in <code>sys 4096</code> or similar in order to execute your code. This will also become important in the next section with the F# program.</p>

<p>BASIC attempts to execute the program it tries to find at <code>$0801</code>. It expects the program to be in a special format which indicates some stuff to do with line numbers, and the PETSCII (Commodore character set - not the same as ASCII!) text of the BASIC source code to be interpreted. Some details will be glossed over here:</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="o">*=</span><span class="w"> </span><span class="mh">$0801</span>

<span class="c1">;autostart</span>
<span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="mh">$0b</span><span class="w"> </span><span class="mh">$08</span><span class="w"> </span><span class="mh">$01</span><span class="w"> </span><span class="mh">$00</span><span class="w"> </span><span class="mh">$9E</span><span class="w"> </span><span class="mh">$34</span><span class="w"> </span><span class="mh">$30</span><span class="w"> </span><span class="mh">$39</span><span class="w"> </span><span class="mh">$36</span><span class="w"> </span><span class="mh">$00</span><span class="w"> </span><span class="mh">$00</span><span class="w"> </span><span class="mh">$00</span><span class="p">)</span>

<span class="o">*=</span><span class="w"> </span><span class="mh">$1000</span><span class="w"> </span><span class="c1">; main program</span>

<span class="c1">; code here ...</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>This is written in my Racket based assembler, <a href="http://docs.racket-lang.org/asi64/index.html">Asi64</a>. It is admittedly very cryptic, being simply a bunch of bytes. The first few are to do with the line numbers. <code>$9E</code> is the code for the <code>sys</code> instruction, followed by four bytes which represent in decimal, as PETSCII characters, the address to jump to. In this case, <code>$34 $30 $39 $36</code> corresponds to <code>4096</code> in decimal (subtract $30 from each character) which in turn is <code>$1000</code> in hex. Finally, the three <code>$00</code> bytes tell BASIC that the line has ended.</p>

<p>Of course, we can write a nice helper in Asi64 to help us do this like you can in <a href="http://theweb.dk/KickAssembler/Main.html#frontpage">KickAssembler</a></p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="n">basic</span><span class="o">-</span><span class="n">upstart</span><span class="w"> </span><span class="mh">$1000</span><span class="p">)</span>

<span class="o">*=</span><span class="w"> </span><span class="mh">$1000</span>

<span class="c1">; code here ...</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The area after the basic program is where we will stuff the remote programmer code. It should be as small as possible, but as long as it fits within the rest of the <code>$0800</code> page we should be fine. I have not optimised it for space yet, what I present below is the first thing I got to work properly!</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">:</span><span class="n">programmer</span><span class="o">-</span><span class="n">check</span>
<span class="w">         </span><span class="c1">;interrupt will be set on a negative transition</span>
<span class="w">         </span><span class="c1">;indicating the pi has put the first byte of a program</span>
<span class="w">         </span><span class="c1">;on the wire</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd0d</span>
<span class="w">         </span><span class="k">and</span><span class="w"> </span><span class="n">@</span><span class="mb">%0001</span><span class="n">_0000</span>
<span class="w">         </span><span class="c1">;if this bit is set then</span>
<span class="w">         </span><span class="c1">;jump. reading this also clears it.</span>
<span class="w">         </span><span class="k">bne</span><span class="w"> </span><span class="n">receive</span><span class="o">-</span><span class="n">program</span><span class="o">+</span>
<span class="w">         </span><span class="k">rts</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>This function checks the interrupt register, and returns if it has not been set. Using <a href="http://docs.racket-lang.org/asi64/index.html#%28part._.Code_.Diagnostics%29">Asi64&rsquo;s diagnostics</a> reveals this code takes 14 cycles if the branch is not taken, so you can comfortably fit a call into this function somewhere in your program, perhaps once a frame.</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">:</span><span class="n">wait</span>
<span class="w">         </span><span class="c1">;toggle pa2 to let the pi know we are done</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd00</span>
<span class="w">         </span><span class="k">eor</span><span class="w"> </span><span class="n">@</span><span class="mb">%0000</span><span class="n">_0100</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="mh">$dd00</span>
<span class="w">         </span><span class="c1">;wait for pi to send a new byte</span>
<span class="p">:</span><span class="n">inner</span><span class="w">   </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd0d</span>
<span class="w">         </span><span class="k">and</span><span class="w"> </span><span class="n">@</span><span class="mb">%0001</span><span class="n">_0000</span><span class="w">                    </span>
<span class="w">         </span><span class="k">beq</span><span class="w"> </span><span class="n">inner</span><span class="o">-</span>

<span class="w">         </span><span class="k">rts</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Next up is this function that waits for a new byte to arrive. First, it toggles the <code>PA2</code> pin indcitating to the Pi that the last byte was been received, and then it sits polling the interrupt register waiting for the new byte to arrive.</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">:</span><span class="n">receive</span><span class="o">-</span><span class="n">program</span><span class="w">   </span>
<span class="w">    </span>
<span class="w">         </span><span class="c1">;some zero page addresses</span>
<span class="w">         </span>
<span class="w">         </span><span class="n">start</span><span class="o">-</span><span class="n">lo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">$40</span>
<span class="w">         </span><span class="n">start</span><span class="o">-</span><span class="n">hi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">$41</span>
<span class="w">         </span><span class="n">total</span><span class="o">-</span><span class="n">pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">$43</span>
<span class="w">         </span><span class="n">first</span><span class="o">-</span><span class="n">page</span><span class="o">-</span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">$44</span>
<span class="w">         </span><span class="n">last</span><span class="o">-</span><span class="n">page</span><span class="o">-</span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">$45</span>
<span class="w">         </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">lo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">$46</span>
<span class="w">         </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">hi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">$47</span>

<span class="w">         </span><span class="c1">;disable interrupts whilst loading  </span>
<span class="w">         </span><span class="k">cli</span>

<span class="w">         </span><span class="c1">;read in the control bytes,</span>
<span class="w">         </span><span class="c1">;todo: write these as an indexed loop</span>
<span class="w">         </span><span class="c1">;to save space</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="n">start</span><span class="o">-</span><span class="n">lo</span>
<span class="w">         </span><span class="k">jsr</span><span class="w"> </span><span class="n">wait</span><span class="o">-</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="n">start</span><span class="o">-</span><span class="n">hi</span>
<span class="w">         </span><span class="k">jsr</span><span class="w"> </span><span class="n">wait</span><span class="o">-</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">lo</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">hi</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="n">total</span><span class="o">-</span><span class="n">pages</span>
<span class="w">         </span><span class="k">jsr</span><span class="w"> </span><span class="n">wait</span><span class="o">-</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span><span class="w">         </span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="n">first</span><span class="o">-</span><span class="n">page</span><span class="o">-</span><span class="n">bytes</span>
<span class="w">         </span><span class="k">jsr</span><span class="w"> </span><span class="n">wait</span><span class="o">-</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="n">last</span><span class="o">-</span><span class="n">page</span><span class="o">-</span><span class="n">bytes</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>This first section reads in the control bytes from the header and stores them in the zero-page. Notably, the <code>data-ptr-lo</code> and <code>data-ptr-high</code> are set to the first address where we should copy data, and it is this pointer that will be manipulated throughout the copy. Notice here the call to <code>cli</code> disables interrupts. This is important, since we are taking over the machine to re-write the program, we don&rsquo;t want the user&rsquo;s interrupt code suddenly trying to execute in the middle of the data transfer!</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="w">         </span><span class="c1">;read/write first page bytes</span>
<span class="w">         </span><span class="k">ldx</span><span class="w"> </span><span class="n">@0</span>
<span class="w">         </span><span class="k">ldy</span><span class="w"> </span><span class="n">@0</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="n">first</span><span class="o">-</span><span class="n">page</span><span class="o">-</span><span class="n">bytes</span><span class="w"> </span><span class="c1">;skip if zero</span>
<span class="w">         </span><span class="k">beq</span><span class="w"> </span><span class="n">main</span><span class="o">+</span><span class="w"> </span><span class="c1">;         </span>
<span class="w">         </span><span class="c1">; read until end of page</span>
<span class="w">      </span><span class="p">:</span><span class="n">next</span>
<span class="w">         </span><span class="c1">;wait for and read the next byte</span>
<span class="w">         </span><span class="k">jsr</span><span class="w"> </span><span class="n">wait</span><span class="o">-</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">         </span><span class="c1">;store it offset with the Y register</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">lo</span><span class="w"> </span><span class="n">y</span>
<span class="w">         </span><span class="c1">;increase Y and check if we are done</span>
<span class="w">         </span><span class="k">iny</span>
<span class="w">         </span><span class="k">cpy</span><span class="w"> </span><span class="n">first</span><span class="o">-</span><span class="n">page</span><span class="o">-</span><span class="n">bytes</span>
<span class="w">         </span><span class="k">bne</span><span class="w"> </span><span class="n">next</span><span class="o">-</span>

<span class="w">         </span><span class="c1">;move to next page</span>
<span class="w">         </span><span class="k">inc</span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">hi</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="n">@0</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">lo</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>This section deals with copying the leading bytes, if there are any. It reads and stores each byte at the <code>data-ptr</code> pointer, offset by the Y register. The loop uses Y to count up until the target amount of bytes have been transferred. The 6502 is better at counting down since you don&rsquo;t need an explicit compare instruction to check for zero, but it would have complicated the protocol too much for not a lot of gain, since this copies at most 255 bytes of data.</p>

<p>Once it has finished, we know we are at the end of the page, so <code>data-ptr-lo</code> is set to zero whilst <code>data-ptr-hi</code> is increased by one, leaving us at the start of the next page ready for the full pages of data.</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="w">     </span><span class="p">:</span><span class="n">main</span>
<span class="w">         </span><span class="k">ldy</span><span class="w"> </span><span class="n">@0</span>
<span class="w">         </span><span class="k">ldx</span><span class="w"> </span><span class="n">total</span><span class="o">-</span><span class="n">pages</span>
<span class="w">         </span><span class="k">beq</span><span class="w"> </span><span class="n">last</span><span class="o">+</span><span class="w">         </span><span class="c1">;skip if zero</span>
<span class="w">         </span><span class="c1">;copy whole pages</span>
<span class="w">     </span><span class="p">:</span><span class="n">loop</span>
<span class="w">         </span><span class="k">jsr</span><span class="w"> </span><span class="n">wait</span><span class="o">-</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">lo</span><span class="w"> </span><span class="n">y</span><span class="w">    </span>
<span class="w">         </span><span class="k">iny</span>
<span class="w">         </span><span class="k">bne</span><span class="w"> </span><span class="n">loop</span><span class="o">-</span>
<span class="w">         </span><span class="k">inc</span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">hi</span>
<span class="w">         </span><span class="k">dex</span>
<span class="w">         </span><span class="k">bne</span><span class="w"> </span><span class="n">loop</span><span class="o">-</span><span class="w">              </span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The main loop for copying bytes uses the X register to count down how many pages we have left to copy, whilst the Y register is increased through 256 values until it overflows. When this happens, 1 is added to <code>data-ptr-hi</code> moving us to the next page. This process repeats until X reaches zero and the whole pages have been copied.</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="w">     </span><span class="p">:</span><span class="n">last</span>
<span class="w">        </span><span class="k">lda</span><span class="w"> </span><span class="n">last</span><span class="o">-</span><span class="n">page</span><span class="o">-</span><span class="n">bytes</span>
<span class="w">        </span><span class="k">beq</span><span class="w"> </span><span class="n">done</span><span class="o">+</span>
<span class="w">     </span><span class="p">:</span><span class="n">loop</span>
<span class="w">        </span><span class="k">jsr</span><span class="w"> </span><span class="n">wait</span><span class="o">-</span>
<span class="w">        </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd01</span>
<span class="w">        </span><span class="k">sta</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="n">data</span><span class="o">-</span><span class="n">ptr</span><span class="o">-</span><span class="n">lo</span><span class="w"> </span><span class="n">y</span><span class="w">        </span>
<span class="w">        </span><span class="k">iny</span>
<span class="w">        </span><span class="k">cpy</span><span class="w"> </span><span class="n">last</span><span class="o">-</span><span class="n">page</span><span class="o">-</span><span class="n">bytes</span>
<span class="w">        </span><span class="k">bne</span><span class="w"> </span><span class="n">loop</span><span class="o">-</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The final loop copies any trailing bytes and is very similar to the first loop.</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="w">      </span><span class="p">:</span><span class="n">done</span>
<span class="w">        </span><span class="c1">;toggle pa2 to let the pi know we are done</span>
<span class="w">        </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd00</span>
<span class="w">        </span><span class="k">eor</span><span class="w"> </span><span class="n">@</span><span class="mb">%0000</span><span class="n">_0100</span>
<span class="w">        </span><span class="k">sta</span><span class="w"> </span><span class="mh">$dd00</span>
<span class="w">        </span><span class="k">ldx</span><span class="w"> </span><span class="n">@$ff</span>
<span class="w">        </span><span class="c1">;delay to let the pin settle </span>
<span class="w">      </span><span class="p">:</span><span class="n">delay</span>
<span class="w">        </span><span class="k">dex</span>
<span class="w">        </span><span class="k">bne</span><span class="w"> </span><span class="n">delay</span><span class="o">-</span>
<span class="w">        </span><span class="k">ldx</span><span class="w"> </span><span class="n">@$ff</span>
<span class="w">      </span><span class="p">:</span><span class="n">delay</span>
<span class="w">        </span><span class="k">dex</span>
<span class="w">        </span><span class="k">bne</span><span class="w"> </span><span class="n">delay</span><span class="o">-</span>
<span class="w">        </span><span class="c1">;splat stack</span>
<span class="w">        </span><span class="k">ldx</span><span class="w"> </span><span class="n">@$ff</span>
<span class="w">        </span><span class="k">txs</span>
<span class="w">        </span><span class="c1">;re-enable interrupts</span>
<span class="w">        </span><span class="k">sei</span>
<span class="w">        </span><span class="c1">;transfer exection to start address</span>
<span class="w">        </span><span class="k">jmp</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="n">start</span><span class="o">-</span><span class="n">lo</span><span class="w"> </span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Now that all the data has been received, the final ceremony Ack&rsquo;s the last byte that was received, then it delays a bunch of cycles to make sure the Pi sees the Ack before the new program begins. This was guesswork rather than science, the speed doesn&rsquo;t really matter at this point.</p>

<p>The next part is very important. Since we don&rsquo;t know where this code was called from and we want to start executing the new program &ldquo;from scratch&rdquo; we reset the machine&rsquo;s stack pointer right back to <code>$ff</code> where it starts from. Then we switch the interrupts back on, and use the indirect jump instruction to transfer program execution to the new program.</p>

<p>The whole thing fits into about 170 bytes, which is not bad. With a little work it could probably be sqaushed into under half a page.</p>

<div class="brush: ca65">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="n">@0</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="mh">$dd03</span><span class="w">  </span><span class="c1">;pin all inputs</span>

<span class="w">         </span><span class="c1">;pa2 is an output</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd02</span><span class="w">         </span>
<span class="w">         </span><span class="k">ora</span><span class="w"> </span><span class="n">@</span><span class="mb">%0000</span><span class="n">_0100</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="mh">$dd02</span>

<span class="w">         </span><span class="c1">;pa2 starts HIGH (inverted)</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd00</span>
<span class="w">         </span><span class="k">and</span><span class="w"> </span><span class="n">@</span><span class="mb">%1111</span><span class="n">_1011</span>
<span class="w">         </span><span class="k">sta</span><span class="w"> </span><span class="mh">$dd00</span>

<span class="w">         </span><span class="c1">;clear any pending int</span>
<span class="w">         </span><span class="k">lda</span><span class="w"> </span><span class="mh">$dd0d</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>One last thing separate from the main program - this small piece of code must go at the start of your program somewhere, it does the boring job of setting up the user port pins properly and clearing any waiting interrupts, leaving the program ready to receive.</p>

<h2 id="f-program">F# Program</h2>

<p>Ideally, I&rsquo;d have Asi64 automatically send the new program over SCP once it has finished assembling. However, I haven&rsquo;t found a nice way of doing so with Racket yet, so for this initial prototype I instead decided to write a small F# program that will watch a directory for changes and copy the files as appropriate using <a href="https://github.com/sshnet/SSH.NET">SSH.NET</a></p>

<p>Of course, things are never quite that straight-forward. The assembler outputs the binary program in a format that the emulator and machine expect. In particular, the first two bytes of the file are the address in the computer where the data should begin. This correlates nicely to bytes 3 and 4 of our protocol headers. However, we are missing one part which is the execution address itself.</p>

<p>Since in this initial version, we know the programs will be using the BASIC upstart program, we can have a look through the binary, locate this code and extract from it the execution address, which can then be prepended to the file before it is sent to the other machine. This is not ideal but it is fine for this version of the project.</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="n">argv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="n">printfn</span><span class="w"> </span><span class="s">"%A"</span><span class="w"> </span><span class="n">argv</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ScpClient</span><span class="o">(</span><span class="s">"192.168.0.20"</span><span class="o">,</span><span class="w"> </span><span class="s">"pi"</span><span class="o">,</span><span class="w"> </span><span class="s">"raspberry"</span><span class="o">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">sendFile</span><span class="w"> </span><span class="o">(</span><span class="n">file</span><span class="o">:</span><span class="n">FileInfo</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stream</span><span class="o">:</span><span class="nn">System</span><span class="p">.</span><span class="nn">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">printfn</span><span class="w"> </span><span class="s">"sending file %s ..."</span><span class="w"> </span><span class="n">file</span><span class="o">.</span><span class="n">FullName</span>
<span class="w">        </span><span class="n">client</span><span class="o">.</span><span class="n">Connect</span><span class="bp">()</span>
<span class="w">        </span><span class="n">client</span><span class="o">.</span><span class="n">Upload</span><span class="o">(</span><span class="n">stream</span><span class="o">,</span><span class="w"> </span><span class="s">"/home/pi/projects/c64/waiting/"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">file</span><span class="o">.</span><span class="n">Name</span><span class="o">)</span>
<span class="w">        </span><span class="n">client</span><span class="o">.</span><span class="n">Disconnect</span><span class="bp">()</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">trySend</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">fi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FileInfo</span><span class="w"> </span><span class="n">file</span>
<span class="w">        </span><span class="c1">// try and find the basic startup program that </span>
<span class="w">        </span><span class="c1">// tells us where the execution point is</span>
<span class="w">        </span><span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">File</span><span class="p">.</span><span class="n">ReadAllBytes</span><span class="w"> </span><span class="n">fi</span><span class="o">.</span><span class="n">FullName</span><span class="w"> </span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">xbuy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x8uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x1uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x0uy</span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x9euy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span>
<span class="w">                  </span><span class="n">a</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x0uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x0uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x0uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">Some</span><span class="w"> </span><span class="o">&lt;|</span>
<span class="w">                        </span><span class="nn">Int32</span><span class="p">.</span><span class="n">Parse</span><span class="o">(</span><span class="n">sprintf</span><span class="w"> </span><span class="s">"%i%i%i%i"</span><span class="w"> </span>
<span class="w">                            </span><span class="o">(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">)</span><span class="w"> </span>
<span class="w">                            </span><span class="o">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">))</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">xbuy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x8uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x1uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x0uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x9euy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span>
<span class="w">                  </span><span class="n">a</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x0uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x0uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="mi">0</span><span class="n">x0uy</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">Some</span><span class="w"> </span><span class="o">&lt;|</span>
<span class="w">                        </span><span class="nn">Int32</span><span class="p">.</span><span class="n">Parse</span><span class="o">(</span><span class="n">sprintf</span><span class="w"> </span><span class="s">"%i%i%i%i%i"</span><span class="w"> </span>
<span class="w">                            </span><span class="o">(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">)</span><span class="w"> </span>
<span class="w">                            </span><span class="o">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">)</span>
<span class="w">                            </span><span class="o">(</span><span class="n">e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x30uy</span><span class="o">))</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">tail</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span>
<span class="w">            </span><span class="n">find</span><span class="w"> </span><span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">toList</span><span class="w"> </span><span class="n">bytes</span><span class="o">)</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">append</span><span class="w"> </span><span class="c1">// little endian   </span>
<span class="w">                            </span><span class="o">[|</span><span class="w"> </span><span class="kt">byte</span><span class="o">(</span><span class="n">address</span><span class="w"> </span><span class="o">&amp;&amp;&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">xFF</span><span class="o">);</span>
<span class="w">                               </span><span class="kt">byte</span><span class="o">((</span><span class="n">address</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">0</span><span class="n">x8</span><span class="o">)</span><span class="w"> </span><span class="o">&amp;&amp;&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">xFF</span><span class="o">);</span><span class="w"> </span><span class="o">|]</span>
<span class="w">                            </span><span class="n">bytes</span>
<span class="w">            </span><span class="k">use</span><span class="w"> </span><span class="n">stream</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MemoryStream</span><span class="o">(</span><span class="n">newBytes</span><span class="o">)</span>
<span class="w">            </span><span class="n">sendFile</span><span class="w"> </span><span class="n">fi</span><span class="w"> </span><span class="n">stream</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">            </span><span class="n">printfn</span><span class="w"> </span><span class="s">"could not find execution point for %s"</span><span class="w"> </span><span class="n">fi</span><span class="o">.</span><span class="n">FullName</span>


<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">watch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileSystemWatcher</span><span class="o">(</span><span class="n">argv</span><span class="o">.[</span><span class="mi">0</span><span class="o">])</span>
<span class="w">    </span><span class="n">watch</span><span class="o">.</span><span class="n">Created</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Event</span><span class="p">.</span><span class="n">add</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="o">.</span><span class="n">FullPath</span><span class="o">.</span><span class="n">EndsWith</span><span class="w"> </span><span class="s">".prg"</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="n">trySend</span><span class="w"> </span><span class="n">x</span><span class="o">.</span><span class="n">FullPath</span><span class="o">)</span>
<span class="w">    </span><span class="n">watch</span><span class="o">.</span><span class="n">EnableRaisingEvents</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>In this not-very-nice F# code, a <code>FileSystemWatcher</code> is used to raise events indicating files have changed in the directory that is passed as a command line parameter. The code then scans through the binary data attempting to find the BASIC program, where it extracts the execution address, appends it to the original bytes litte-endian style and finally sends the data across to the Pi via SCP.</p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>Measuring this first version on my scope reveals the <code>PA2</code> pin transitioning at about 50 microseconds, yielding a transfer rate of about 20khz, or almost 20kb of data per second, which is not too bad at all. It is very cool to use the laptop from anywhere, assemble some new code and see it run automatically on the C64 across the room! Whilst this version is designed to overwrite an entire program, the protocol has no such limitations and will copy some bytes to any location you like. It is not hard to imagine that with a little work you could setup a REPL style system for assembler code, allowing you to send and execute small snippets on the real machine.</p>

<p>The next step is to take the hardware and make a more permanent circuit with it instead of it being on a breadboard, so you can simply plug it into a C64 and Pi running the correct software.</p>
  <footer>
    <ul class="pager">
    <li class="previous">
      <a href="/blog\2019\04\17\fairylog/">&larr; <em>Fairylog</em></a>
    </li>
    <li class="next">
      <a href="/blog\2018\10\05\c64-macro-state-machine/"><em>C64 Macro State Machine</em> &rarr;</a>
    </li>
    </ul>
    <script type="text/javascript">
      !function(d,s,id){
          var js,fjs=d.getElementsByTagName(s)[0];
          if(!d.getElementById(id)){
              js=d.createElement(s);
              js.id=id;
              js.src="//platform.twitter.com/widgets.js";
              fjs.parentNode.insertBefore(js,fjs);
          }
      }(document,"script","twitter-wjs");
    </script>
    <a href="https://twitter.com/share"
       class="twitter-share-button"
       data-url="http://www.pinksquirrellabs.com/blog\2018\11\21\c64-remote-programmer/"
       data-dnt="true">
      "Tweet"</a>

  </footer>
</article>
        </div>
      </div>
      <footer>
        <hr />
        <p><a href="https://twitter.com/pezi_pink"
              class="twitter-follow-button"
              data-show-count="false"
              data-lang="en">
             "Follow pezi_pink"
           </a>
           <script type="text/javascript">
             !function(d,s,id){
                 var js,fjs=d.getElementsByTagName(s)[0];
                 if(!d.getElementById(id)){
                     js=d.createElement(s);
                     js.id=id;
                     js.src="//platform.twitter.com/widgets.js";
                     fjs.parentNode.insertBefore(js,fjs);
                 }
             }(document,"script","twitter-wjs");
           </script></p>
      </footer>
    </div>
    <!-- </body> JS -->
    <script type="text/javascript" src="//code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  </body>
</html>