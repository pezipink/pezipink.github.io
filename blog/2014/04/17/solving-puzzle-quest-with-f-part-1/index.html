<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Solving Puzzle Quest with F# Part 1</title>
    <meta name="description" content="Tomas Petricek posted an article recently about how he used F# to solve a puzzle he had been given for Christmas. This reminded me of several similar mini-projects I have developed in the past, the most recent being a program to help solve a specific sort...">
    <meta name="author"      content="pezi">
    <meta name="keywords"    content="fsharp">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="http://www.pinksquirrellabs.com/blog\2014\04\17\solving-puzzle-quest-with-f-part-1/">
    <link rel="next" href="/blog\2014\02\21\the-don-syme-type-provider/">
    <link rel="prev" href="/blog\2014\05\01\basic-s-50th-anniversary-and-more-crazy-f-type-providers/">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <!-- Feeds -->
    <link rel="alternate" type="application/rss+xml"
          href="/feeds\all.rss.xml" title="RSS Feed">
    <!-- JS -->

  </head>
  <body>
    <!-- A standard Twitter Bootstrap nav bar -->
    <header class="navbar navbar-default navbar-inverse"
            role="banner">
      <div class="container">
        <div class="navbar-header">
          <button type="button"
                  class="navbar-toggle"
                  data-toggle="collapse"
                  data-target=".our-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="/index.html" class="navbar-brand">Pink Squirrel Labs</a>
        </div>
        <div class="collapse navbar-collapse our-nav-collapse"
             role="navigation">
          <ul class="nav navbar-nav">

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="/index.html">All Posts</a></li>

<li><a href="/tags\6502.html">6502</a></li>

<li><a href="/tags\asi64.html">asi64</a></li>

<li><a href="/tags\books.html">books</a></li>

<li><a href="/tags\C.html">C</a></li>

<li><a href="/tags\C64.html">C64</a></li>

<li><a href="/tags\compilers.html">compilers</a></li>

<li><a href="/tags\cracking.html">cracking</a></li>

<li><a href="/tags\D.html">D</a></li>

<li><a href="/tags\digital-logic.html">digital logic</a></li>

<li><a href="/tags\drey.html">drey</a></li>

<li><a href="/tags\electronics.html">electronics</a></li>

<li><a href="/tags\fairylog.html">fairylog</a></li>

<li><a href="/tags\fpga.html">fpga</a></li>

<li><a href="/tags\fsharp.html">fsharp</a></li>

<li><a href="/tags\game-programming.html">game programming</a></li>

<li><a href="/tags\macros.html">macros</a></li>

<li><a href="/tags\programming-languages.html">programming languages</a></li>

<li><a href="/tags\racket.html">racket</a></li>

<li><a href="/tags\raspberry-pi.html">raspberry pi</a></li>

<li><a href="/tags\reverse-engineering.html">reverse engineering</a></li>

<li><a href="/tags\robotics.html">robotics</a></li>

<li><a href="/tags\roguelike.html">roguelike</a></li>

<li><a href="/tags\scurry.html">scurry</a></li>

<li><a href="/tags\sqlprovider.html">sqlprovider</a></li>

<li><a href="/tags\squirrels.html">squirrels</a></li>

<li><a href="/tags\type-providers.html">type providers</a></li>

<li><a href="/tags\xrm.html">xrm</a></li>
              </ul>
            </li>
            <li>
              <a href="/About.html">About</a>
            </li> 
            <li><a href="/feeds\all.rss.xml">RSS</a></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row">

        <!-- Main column -->
        <div id="content" class="col-md-12">





          <article>
  <header>
    <ul class="pager">
    <li class="previous">
      <a href="/blog\2014\05\01\basic-s-50th-anniversary-and-more-crazy-f-type-providers/">&larr; <em>BASIC’s 50th Anniversary … and more crazy F# type providers!</em></a>
    </li>
    <li class="next">
      <a href="/blog\2014\02\21\the-don-syme-type-provider/"><em>The Don Syme type provider</em> &rarr;</a>
    </li>
    </ul>
    <h1>Solving Puzzle Quest with F# Part 1</h1>
    <p class='date-and-tags'>
<time datetime="2014-04-17" pubdate="true">2014-04-17</time> :: <span class="tags"><a href="/tags\fsharp.html">fsharp</a></span></p>
  </header>

<p><a href="http://tomasp.net/blog/2014/puzzling-fsharp/index.html">Tomas Petricek posted an article recently</a> about how he used F# to solve a puzzle he had been given for Christmas. This reminded me of several similar mini-projects I have developed in the past, the most recent being a program to help solve a specific sort of puzzle in the game <a href="http://store.steampowered.com/app/12500/">Puzzle Quest</a>, which I shall now describe.</p>

<p>Puzzle Quest is a match-3 game, with various game modes. One game mode in particular, &ldquo;Capture&rdquo;, has a specific layout of tiles which can be matched in a certain way to leave no tiles behind at the end. Some of these are really quite tricky, and I thought it would be fun to write a program to solve them. Here is a example of a puzzle:</p>
<!-- more-->

<p><a href="http://www.pinksquirrellabs.com/img/old/image_7.png"><img style="display: inline; border: 0px;" title="image" src="../../../../../img/old/image_thumb_7.png" alt="image" width="199" height="233" border="0" /></a></p>

<h2>Domain</h2>

<p>As ever with F#, the first thing you do is write the types you will need to represent the problem. Because the game is very much about mutable state, and the order of things is important, it is natural to represent the board itself as a two dimensional array. The game has a bunch of different tile types that can appear in the grid somewhere, which are easily modelled by the very awesome discriminated union:</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">type</span><span class="w"> </span><span class="nc">Tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Purple</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Coin</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Skull</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Flaming</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Blank</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Notice skull is slightly different - this is because there are two types of skull. You get normal skulls, and exploding ones - they function the same in terms of matching, but when a flaming skull is part of a match, it also destroys all 8 tiles around it (recursively - this explosion can take out further exploding skulls). Thanks to the mega awesome discriminated union, I can really easily model additional behavior of the skull within the type.</p>

<p>What else is required? Err&hellip; not much really, that&rsquo;s about it! One other small thing that will be required though is directions - the processing steps will have to move along in certain directions to discover matches, and other stuff</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">type</span><span class="w"> </span><span class="nc">Direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Up</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span>
</pre></div></td></tr></tbody></table></div>

</div>

<h2>IO</h2>

<p>Obviously, I need an easy way to express a board, and a way to print them as well. This is very easily done with a string:</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">let</span><span class="w"> </span><span class="nv">createBoard</span><span class="w"> </span><span class="o">(</span><span class="n">text</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="o">,</span><span class="s">""</span><span class="o">)</span><span class="w"> </span>
<span class="w">                 </span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="s">"</span><span class="se">\r</span><span class="s">"</span><span class="o">,</span><span class="s">""</span><span class="o">)</span><span class="w"> </span>
<span class="w">                 </span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="s">" "</span><span class="o">,</span><span class="s">""</span><span class="o">).</span><span class="n">ToCharArray</span><span class="bp">()</span><span class="w"> </span>

<span class="w">  </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">data</span><span class="o">.[</span><span class="n">row</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="k">with</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;y&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;b&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;g&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;r&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;c&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Coin</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;p&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Purple</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;s&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Skull</span><span class="w"> </span><span class="k">false</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;S&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Skull</span><span class="w"> </span><span class="k">true</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;_&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Blank</span><span class="w"> </span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwithf</span><span class="w"> </span><span class="s">"unexpected input &#39;%c&#39;"</span><span class="w"> </span><span class="n">x</span><span class="o">)</span>

<span class="k">let</span><span class="w"> </span><span class="nv">printBoard</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="nv">sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="nn">Text</span><span class="p">.</span><span class="n">StringBuilder</span><span class="bp">()</span><span class="w"> </span>
<span class="w">  </span><span class="n">board</span>
<span class="w">  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">iteri</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">      </span><span class="k">match</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="k">with</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"y"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"b"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"g"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"r"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Skull</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"S"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Skull</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"s"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Purple</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"p"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Coin</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"c"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">Blank</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">Append</span><span class="o">(</span><span class="s">"_"</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">sb</span><span class="o">.</span><span class="n">AppendLine</span><span class="bp">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="o">)</span><span class="w"> </span>
<span class="w">  </span><span class="n">sb</span><span class="o">.</span><span class="n">ToString</span><span class="bp">()</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Nice and simple so far, now I can create a board by doing something like this</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">let</span><span class="w"> </span><span class="nv">wight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="n">createBoard</span><span class="w"> </span>
<span class="w">    </span><span class="s">"""___rr___ </span>
<span class="s">    ___rr___ </span>
<span class="s">    ___gg___ </span>
<span class="s">    ___rr___ </span>
<span class="s">    _g_gg_g_ </span>
<span class="s">    _g_gg_g_ </span>
<span class="s">    _sgssgs_ </span>
<span class="s">    sggssggs </span>
<span class="s">    """</span>
</pre></div></td></tr></tbody></table></div>

</div>

<h2>Processing Logic</h2>

<p>Now for the good stuff .. before thinking about attempting to solve a puzzle, first I must be able to fully emulate the process that occurs when two tiles are swapped (the player makes a move).</p>

<ol>
 <li>Swap the two tiles</li>
 <li>Search in all directions from the two new tiles to find a chain of 2+ tiles of the same type</li>
 <li>The resulting tiles will need to be removed - but watch out for flaming skulls! these will also remove all their neighbours, and this process will continue if more flaming skulls are hit in the explosion</li>
 <li>Once all the tiles have been removed, all tiles above the removed ones will need to be moved down the correct amount of places to fill the gaps</li>
 <li>Now, ALL tiles that were affected (eg all the ones that were moved down to fill gaps) will need to have this whole process from 2. performed on them, to find any chain-matches. Not only that, but they must all be processed at the SAME time to ensure the configuration of the board is not changed between evaluating each affected tile.</li></ol>

<p>Whew - this is actually pretty complicated! There&rsquo;s various things to trip over on the way, but as you can see a lot of this lends itself well to recursive processing, which means that as usual F# is an awesome fit for this kind of problem.</p>

<p>Firstly, a small function that safely gets the neighbour of a tile in a given direction</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">let</span><span class="w"> </span><span class="nv">getNeighbour</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="n">Tile</span><span class="o">[,])</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="k">match</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="k">with</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Up</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">,</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">col</span><span class="o">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">None</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">,</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">col</span><span class="o">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">None</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="w"> </span><span class="o">,</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">None</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span><span class="o">-&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="o">],</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">None</span><span class="w"> </span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>And a special one to safely get all surrounding tiles, for use with processing those pesky flaming skulls</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">let</span><span class="w"> </span><span class="nv">getSurroundingTiles</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="n">Tile</span><span class="o">[,])</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="o">[-</span><span class="mi">1</span><span class="o">,-</span><span class="mi">1</span><span class="o">;</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">;</span><span class="w"> </span>
<span class="w">   </span><span class="mi">0</span><span class="o">,-</span><span class="mi">1</span><span class="o">;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">;</span><span class="w"> </span>
<span class="w">   </span><span class="mi">1</span><span class="o">,-</span><span class="mi">1</span><span class="o">;</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">;]</span><span class="w"> </span>
<span class="w">  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">rd</span><span class="o">,</span><span class="w"> </span><span class="n">cd</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="nv">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>
<span class="w">        </span><span class="n">Some</span><span class="o">(</span><span class="n">board</span><span class="o">.[</span><span class="n">r</span><span class="o">,</span><span class="n">c</span><span class="o">],</span><span class="w"> </span><span class="n">r</span><span class="o">,</span><span class="w"> </span><span class="n">c</span><span class="o">)</span><span class="w"> </span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="n">None</span><span class="o">)</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>And next a very cool function that, given a starting location and direction, will produce a sequence of tiles until a different kind of tile is found. Seq.unfold is a very nice way of achieving this. If you are new to functional programming then Seq.unfold will likely make your head explode, play around with it though as it&rsquo;s great once you understand how to use it!</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">let</span><span class="w"> </span><span class="nv">unfoldMatches</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w"> </span><span class="o">(</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">,</span><span class="n">direction</span><span class="o">)</span><span class="w"> </span>
<span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Seq</span><span class="p">.</span><span class="n">unfold</span><span class="o">(</span><span class="w"> </span>
<span class="w">     </span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">,</span><span class="n">direction</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">         </span><span class="k">match</span><span class="w"> </span><span class="n">getNeighbour</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="k">with</span><span class="w"> </span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">tile</span><span class="o">,</span><span class="n">newRow</span><span class="o">,</span><span class="n">newCol</span><span class="o">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Some</span><span class="o">((</span><span class="n">tile</span><span class="o">,</span><span class="n">newRow</span><span class="o">,</span><span class="n">newCol</span><span class="o">),(</span><span class="n">newRow</span><span class="o">,</span><span class="n">newCol</span><span class="o">,</span><span class="n">direction</span><span class="o">))</span><span class="w"> </span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">)</span><span class="w"> </span>
<span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Notice <em>when f tile</em> - <em>f</em>is a function that is passed in, and it is used to determine when the sequence should stop. The reason I have not simply used equality on the tile type is because those pesky skulls again. Whilst Skull(true) and Skull(false) are the same union case, they are not equivalent, however for purposes of the matching they should always be treated as equivalent - this is achieved via <em>f</em> as you will see soon. This is also the reason why the unfold function returns the tile types - this wouldn&rsquo;t usually be necessary as I should already <em>know</em> the tile type, but in the case of the skulls I need to be able to disambiguate them at a later stage, so the flaming ones can be processed appropriately.</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">let</span><span class="w"> </span><span class="nv">getBasicMatches</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="n">Tile</span><span class="o">[,])</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w"> </span><span class="o">[</span><span class="n">Left</span><span class="o">,</span><span class="n">Right</span><span class="o">;</span><span class="n">Up</span><span class="o">,</span><span class="n">Down</span><span class="o">]</span><span class="w"> </span>
<span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">dira</span><span class="o">,</span><span class="n">dirb</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">     </span><span class="n">unfoldMatches</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">dira</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">unfoldMatches</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">dirb</span><span class="w"> </span><span class="n">f</span><span class="w"> </span>
<span class="w">     </span><span class="o">|&gt;</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="o">_::_::_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">)</span><span class="w"> </span>
<span class="w">     </span><span class="c1">// don&#39;t forget to include the original tile </span>
<span class="w">     </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">],</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">)::</span><span class="n">matches</span><span class="o">)</span><span class="w"> </span>
<span class="w">     </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="n">id</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>This function might be confusing for various reasons! Notice here that I match <em>both</em> left and right at the same time, then <em>both</em>up and down at the same time. The reason for this is because the tile in question might be in the centre of a 3+ match, therefore I cannot simply check left or right. This approach instead does both at the same time, appends the results together, then looks at the resulting list. If it has 2 or more tiles -achieved using list pattern match ( _::_::_ ) that matches 2 or more elements plus a tail - then it is returned. I use 2 here and not 3 because the tile under question is not included in the match, which is why it is added afterwards to the results. Finally, the lists are flattened out into one big list of results using <em>List.collect</em> <em>id</em></p>

<p>But wait! I've forgotten about those damn flaming skulls.. this bit is a little tricky. Given the matches returned, I need to find any flaming skulls, and add all their surrounding tiles to the results list - and if any of those surrounding tiles are also flaming skulls, the process has to be repeated recursively.</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="c1">// get all 3+ of a kind matches from a given point, </span>
<span class="c1">// including any chained flaming skulls along the path </span>
<span class="k">let</span><span class="w"> </span><span class="nv">getMatches</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="n">Tile</span><span class="o">[,])</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">processFlamingSkull</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="n">getSurroundingTiles</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">partition</span><span class="o">(</span><span class="k">function</span><span class="w"> </span><span class="o">(</span><span class="n">Skull</span><span class="o">(</span><span class="k">true</span><span class="o">),_,_)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">false</span><span class="o">)</span><span class="w"> </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="k">function</span><span class="w"> </span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="bp">[]</span><span class="o">,</span><span class="w"> </span><span class="n">toRemove</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">toRemove</span><span class="w"> </span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">skulls</span><span class="o">,</span><span class="w"> </span><span class="n">toRemove</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">            </span><span class="n">skulls</span><span class="w"> </span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(_,</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">processFlamingSkull</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">exists</span><span class="w"> </span><span class="o">((=)</span><span class="n">t</span><span class="o">)</span><span class="w"> </span><span class="n">toRemove</span><span class="o">))</span><span class="w"> </span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="n">id</span><span class="w"> </span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">append</span><span class="w"> </span><span class="n">toRemove</span><span class="w"> </span>
<span class="w">            </span>
<span class="w">  </span><span class="k">match</span><span class="w"> </span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="k">with</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Blank</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span>
<span class="w">  </span><span class="c1">// for skulls, I want to match both types regardless of this type </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="n">Skull</span><span class="o">(_))</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="k">function</span><span class="w"> </span><span class="n">Skull</span><span class="o">(_)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">false</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">getBasicMatches</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span>
<span class="w">      </span><span class="c1">// collect up any chained flaming skull tiles and append to original results </span>
<span class="w">      </span><span class="n">results</span><span class="w"> </span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="k">function</span><span class="w"> </span><span class="o">(</span><span class="n">Skull</span><span class="o">(</span><span class="k">true</span><span class="o">),</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">processFlamingSkull</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="o">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">)</span><span class="w"> </span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="n">id</span><span class="w"> </span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">append</span><span class="w"> </span><span class="n">results</span><span class="w"> </span>
<span class="w">  </span><span class="c1">// all other tiles are a straight match </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(=)</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">getBasicMatches</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>More head exploders in here :) (pun fully intended.) In <em>processFlamingSkull</em>,<em>a</em>fter getting a skull&rsquo;s surrounding tiles, I use <em>List.partition</em> to split off any of them that are flaming skulls. If there are none, I just return the rest of the tiles. If there are some, the list is mapped over recursively using the same function, after first removing any skulls already encountered - otherwise I would get caught in infinite recursion. The results are collected up and finally appended to the other tiles to be destroyed. This function then returns one single big list that contains all tiles destroyed by chained flaming skulls.</p>

<p>PHEW! There&rsquo;s still a lot left though, first of which is the &ldquo;gravity&rdquo; effect after removing tiles. This is actually fairly complicated depending on how you choose to do it. It is essentially like &ldquo;defragging&rdquo; an array, and there might be several blocks of empty tiles to deal with in any column. I figured that the easiest way to do this would be as follows:</p>

<p>For a column that had tiles removed</p>

<ol>
 <li>Create a list of tiles from the bottom up, skipping out any blanks</li>
 <li>Blank the entire column</li>
 <li>Place tiles back in the order from the list</li></ol>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="c1">// performs "gravity" effect on a column, and returns </span>
<span class="c1">// affected tiles </span>
<span class="k">let</span><span class="w"> </span><span class="nv">defragColumn</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="n">Tile</span><span class="o">[,])</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">blankTiles</span><span class="o">,</span><span class="n">activeTiles</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">r</span><span class="o">,</span><span class="n">board</span><span class="o">.[</span><span class="n">r</span><span class="o">,</span><span class="n">col</span><span class="o">]]</span><span class="w"> </span>
<span class="w">                                 </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">partition</span><span class="o">(</span><span class="k">function</span><span class="w"> </span><span class="o">(_,</span><span class="n">Blank</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">false</span><span class="o">)</span><span class="w"> </span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">board</span><span class="o">.[</span><span class="n">r</span><span class="o">,</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Blank</span><span class="w"> </span>
<span class="w">  </span><span class="n">activeTiles</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">iteri</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">(_,</span><span class="n">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">board</span><span class="o">.[</span><span class="mi">7</span><span class="o">-</span><span class="n">r</span><span class="o">,</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">t</span><span class="o">)</span><span class="w"> </span>
<span class="w">  </span><span class="n">blankTiles</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">choose</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">board</span><span class="o">.[</span><span class="n">r</span><span class="o">,</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Blank</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">None</span><span class="o">)</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>I realised that once all columns had been &ldquo;defragged&rdquo; that all the affected tiles on the board would now need to go through the whole match cycle again, <em>at the same time</em>, to process any chain-matching caused from the tiles dropping down. However, I don&rsquo;t want to process the <em>whole</em>board (although that would be fine, as it is tiny). Instead I&rsquo;d like to be clever about it and only process tiles that could possibly be affected. As far as I can tell, this is any tile that was blanked out and now had something else fall into it - so this is why the function above also returns a list of tiles that were empty before the gravity kicked in and are no longer empty.</p>

<p>So, the last piece of the puzzle (pun fully intended) before I can build something to solve the problem, is the core algorithm that uses all the above stuff to fully process a given amount of tiles that have been mutated, all at once.</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="c1">// process a step - remove tiles and move ones above down </span>
<span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">processStep</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">tilesToProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="c1">// get all matches from all affected tiles </span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="nv">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="n">tilesToProcess</span><span class="w"> </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getMatches</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="o">)</span><span class="w"> </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="n">id</span><span class="w"> </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">ofList</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">matches</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="k">else</span><span class="w"> </span>
<span class="w">  </span><span class="c1">// remove the tiles </span>
<span class="w">  </span><span class="n">matches</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">iter</span><span class="o">(</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">(_,</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Blank</span><span class="o">)</span>

<span class="w">  </span><span class="c1">// "defrag" / apply gravity </span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="nv">affectedTiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="n">matches</span><span class="w"> </span>
<span class="w">    </span><span class="c1">// get distinct column list from matches </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">map</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(_,_,</span><span class="n">col</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">col</span><span class="o">)</span><span class="w"> </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">toList</span><span class="w"> </span>
<span class="w">    </span><span class="c1">// defrag and collect results </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">defragColumn</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">)))</span><span class="w"> </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="n">id</span><span class="w"> </span>
<span class="w">    </span><span class="c1">// remove dupes </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">ofList</span><span class="w"> </span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">toList</span>
<span class="w">  </span>
<span class="w"> </span><span class="c1">// recursively process all affected tiles in one pass </span>
<span class="w"> </span><span class="n">processStep</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">affectedTiles</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p></p>

<p>This is it! This function takes in any amount of tile locations with which to process. It then finds all 3+ matches and chained exploding skull tiles. All the matches are then removed. Then, for each distinct column involved in the matches, the &ldquo;defrag / gravity&rdquo; process is called, which returns all further tiles that have subsequently been affected - these then have any duplicates removed, and the whole process is called recursively until no new matches are found.</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">let</span><span class="w"> </span><span class="nv">makeMove</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="n">Tile</span><span class="o">[,])</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="c1">// swap tiles </span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="nv">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">]</span>

<span class="w">  </span><span class="k">match</span><span class="w"> </span><span class="n">getNeighbour</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="k">with</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">otherTile</span><span class="o">,</span><span class="n">otherRow</span><span class="o">,</span><span class="n">otherCol</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">      </span><span class="n">board</span><span class="o">.[</span><span class="n">otherRow</span><span class="o">,</span><span class="n">otherCol</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">tile</span><span class="w"> </span>
<span class="w">      </span><span class="n">board</span><span class="o">.[</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">otherTile</span><span class="w"> </span>
<span class="w">      </span><span class="o">(</span><span class="n">processStep</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">[</span><span class="n">row</span><span class="o">,</span><span class="n">col</span><span class="o">;</span><span class="n">otherRow</span><span class="o">,</span><span class="n">otherCol</span><span class="o">])</span>

<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">"illegal move"</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>This function lets me perform a move on a given board configuration, so the behaviours can be tested. The Wight puzzle from the start of the post can be solved like so:</p>

<div class="brush: fsharp">
 <div class="highlight">
  <table class="highlighttable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="k">let</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeMove</span><span class="w"> </span><span class="n">wight</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">Up</span><span class="w"> </span>
<span class="k">let</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeMove</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">Up</span><span class="w"> </span>
<span class="k">let</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeMove</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span>
<span class="k">let</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeMove</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span>
<span class="k">let</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeMove</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span>
<span class="k">let</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeMove</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">Up</span><span class="w"> </span>
<span class="k">let</span><span class="w"> </span><span class="nv">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeMove</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">Up</span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Cool! Effectively I have now completely emulated the puzzle quest mechanics, you could very easily use this processing code to write your own match-3 game :)</p>

<p>Next up is how to actually find solutions to a given puzzle. This challenge is equally fraught with peril. How can you determine which moves are currently possible? Is it possible to simply brute-force, or is the problem space too big? Will I run into tail-call issues? Will it be super-slow, and if so can it be improved with various optimisation techniques?</p>

<p>Stay tuned for the next part to find out!</p>
  <footer>
    <ul class="pager">
    <li class="previous">
      <a href="/blog\2014\05\01\basic-s-50th-anniversary-and-more-crazy-f-type-providers/">&larr; <em>BASIC’s 50th Anniversary … and more crazy F# type providers!</em></a>
    </li>
    <li class="next">
      <a href="/blog\2014\02\21\the-don-syme-type-provider/"><em>The Don Syme type provider</em> &rarr;</a>
    </li>
    </ul>

  </footer>
</article>
        </div>
      </div>
      <footer>
        <hr />

      </footer>
    </div>
    <!-- </body> JS -->
    <script type="text/javascript" src="//code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  </body>
</html>